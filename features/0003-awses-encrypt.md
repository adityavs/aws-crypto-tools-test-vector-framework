
|           |                                  |
|:----------|:---------------------------------|
|__Feature__|AWS Encryption SDK Encrypt Message|
|__Version__|1                                 |
|__Created__|2016-06-25                        |
|__Updated__|2018-07-10                        |

## Dependencies

This serves as a reference of all features that this feature depends on.

| Feature                  | Min Version                              | Max Version                              |
|--------------------------|------------------------------------------|------------------------------------------|
| Name and link to feature | Minimum version required by this feature | Maximum version required by this feature |
| Name and link to feature | Minimum version required by this feature | Maximum version required by this feature |

## Experimental Implementations

This serves as a reference for which implementations support this experimental feature. This
section should be removed once this feature is promoted from experimental status.

Unique implementations required for promotion: 2

| Repository                | Language | Pull Request                    |
|---------------------------|----------|---------------------------------|
| Link to GitHub repository | Language | Pull request that added support |
| Link to GitHub repository | Language | Pull request that added support |

## Supported Implementations

This serves as a references for which implementations support this feature. A minimum of two supporting implementations
are required for new feature versions.

| Repository                | Language | Feature Version                   | Minimum Version                                    | Pull Request                    |
|---------------------------|----------|-----------------------------------|----------------------------------------------------|---------------------------------|
| Link to GitHub repository | Language | Supported version of this feature | Minimum version that supports this feature version | Pull request that added support |
| Link to GitHub repository | Language | Supported version of this feature | Minimum version that supports this feature version | Pull request that added support |

## Summary

The AWS Encryption SDK Encrypt manifest defines rules for generating full ciphertext message 
test vectors. This includes all necessary details such as master key(s), encryption context, 
algorithm suite, and frame size.

## Out of Scope

This is not a description of how the test vectors that will be generated by a compatible 
client should be decrypted.

## Motivation

We need a way of describing all scenarios that we want to cover with test vectors for full AWS 
Encryption SDK ciphertext messages. This will be used both for generating known good test vectors 
with a known good implementation as well as for generating test vectors with an unknown implementation 
to be tested for compatibility using a known good implementation.

## Guide-level Explanation

This manifest describes test vectors to create. These test cases will result in complete AWS 
Encryption SDK ciphertext messages along with a corresponding 0004-awses-decrypt manifest.

Each test case includes all necessary instructions to construct ciphertext message. This includes 
all necessary inputs including algorithm suite, frame size, encryption context, and master key(s).

### Workflow

1. Read encrypt manifest.
2. Generate plaintexts and write to destination.
3. Generate all required test vectors for each plaintext, writing ciphertext to destination.
4. Generate decrypt manifest file and write to destination.

## Reference-level Explanation

The `0003-awses-encrypt-generate.py` script in this package will generate a manifest that describes 
the below test cases and references the keys manifest generated by `0002-keys-generate.py`. This 
should be treated as the canonical AWS Encryption SDK encrypt manifest file, defining all encrypt 
test vectors that a complete implementation should be able to generate.

### Scenarios to test

#### Algorithm Suites

* Every Algorithm Suite supported by the AWS Encryption SDK

#### Framing

* Non-framed message
* Framed message with frame size smaller than plaintext size
* Framed message with frame size equal to plaintext size
* Framed message with frame size larger than plaintext size
* Framed message with >10 frames

#### Encryption Context

* Message without encryption context
* Message with encryption context
* Unicode values in encryption context
* No unicode values in encryption context
* Binary values in encryption context
* No binary values in encryption context

#### Master Key Providers

* Single AWS KMS MasterKey which can be decrypted by all consumers
* Multiple AWS KMS MasterKeys, of which only one can be decrypted by all consumers
* Single AES Symmetric Raw MasterKey as described above, which can be decrypted
* Multiple Symmetric Raw MasterKeys as described above, only one of which can be decrypted
* Single RSA Asymmetric Raw MasterKey as described above, which can be decrypted
* Multiple Asymmetric Raw MasterKeys as described above, only one of which can be decrypted

### Contents

### manifest

Identifies this manifest.

* `type` : Identifies the type of manifest
   * Must be `awses-encrypt`
* `version`: Identifies the manifest format version

#### keys

URI identifying a keys manifest to use with all tests.

#### plaintexts

Map of plaintext names to size in bytes.

These plaintexts will be generated by the client and should be a random byte vectors of the specified 
number of bytes.

#### tests

Map object mapping a test case ID to a test case description that describes how to generate a 
test vector.

* `plaintext` : Plaintext source name
* `algorithm` : Hex string of supported [Algorithm ID](http://docs.aws.amazon.com/encryption-sdk/latest/developer-guide/algorithms-def.html)
* `frame-size` : Frame size in bytes (0 for nonframed)
* `encryption-context` : Map of keys and values to use for encryption context
* `master-keys` : List of Master Key descriptions:
   * `type` : Type of master key
     * Allowed Values
       * `aws-kms`
       * `raw`
   * `key` : Name of key from `keys` manifest
   * `key-id` : Master Key ID (optional) (default: `key` name or `key.key-id` for AWS KMS)
   * `provider-id` : Master Key Provider ID (required for Raw Master Keys)
   * `encryption-algorithm` : Encryption Algorithm (required for Raw Master Keys)
      * Allowed Values
          * `aes`
          * `rsa`
   * `padding-algorithm` : Padding Algorithm (required for RSA Raw Master Keys)
      * Allowed Values
          * `pkcs1`
          * `oaep-mgf1`
   * `padding-hash` : Hash Algorithm used with Padding Algorithm (required if `padding-algorithm` is `oaep-mgf1`)
      * Allowed Values
          * `sha1`
          * `sha256`
          * `sha384`
          * `sha512`


### Example

```json
{
    "manifest": {
        "type": "awses-encrypt",
        "version": 1
    },
    "keys": "file://relative/file/path.json",
    "plaintexts": {
        "small": 1024,
    },
    "tests": {
        "2d1e0da9-74f8-4817-842d-c2b973abed7c": {
            "plaintext": "small",
            "algorithm": "0014",
            "frame-size": 1024,
            "encryption-context": {},
            "master-keys": [
                {
                    "type": "raw",
                    "provider-id": "aws-raw-vectors-persistant",
                    "key": "rsa-4096-private",
                    "encryption-algorithm": "rsa",
                    "padding-algorithm": "oaep-mgf1",
                    "padding-hash": "sha256"
                }
            ]
        },
        "f7f3416b-7527-4108-8d15-6d0d5a377a2c": {
            "plaintext": "small",
            "algorithm": "0378",
            "frame-size": 500,
            "encryption-context": {
                "classification": "secret squirrel",
                "nuts": "acorn"
            },
            "master-keys": [
                {
                    "type": "aws-kms",
                    "key": "us-west-2-decryptable",
                    
                },
                {
                    "type": "aws-kms",
                    "key": "us-west-2-encrypt-only",
                    
                }
            ]
        }
    }
}
```
